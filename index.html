<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>Novaklar Portal</title>
    <link rel="preconnect" href="https://fonts.googleapis.com"/>
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin/>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;700&display=swap" rel="stylesheet"/>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css"/>
    <style>
        @font-face {
            font-family: 'Poppins-Bold';
            src: url('https://raw.githubusercontent.com/novaklar/web/main/Poppins-Bold.ttf') format('truetype');
            font-weight: 700;
            font-style: normal;
        }

        @font-face {
            font-family: 'Poppins-Regular';
            src: url('https://raw.githubusercontent.com/novaklar/web/main/Poppins-Regular.ttf') format('truetype');
            font-weight: 400;
            font-style: normal;
        }

        :root{
            --accent-dark: #080a33; /* used for logos and portal bg */
            --portal-bg: #080a33;
            --portal-text: #f1efee;
            --page-bg: #f1efee;
            --reclutamiento-bg: #7fcfda;
            --reclutamiento-text: #0d4c7f;
            --comercial-bg: #0d4c7f;
            --comercial-text: #7fcfda;
        }

        /* General styles */
        html,body{
            margin:0;
            padding:0;
            font-family: 'Poppins-Regular', sans-serif;
            background-color: var(--page-bg); /* Requirement: general background #f1efee */
            color: #000;
            -webkit-font-smoothing:antialiased;
            -moz-osx-font-smoothing:grayscale;
        }

        header{
            position:sticky;
            top:0;
            z-index:1000;
            padding:10px 0;
            text-align:center;
            background: transparent;
            backdrop-filter: blur(8px);
            -webkit-backdrop-filter: blur(8px);
        }

        /* Logo container: will hold two inline SVGs that alternate */
        .logo-container{
            width:160px;
            height:70px;
            margin:0 auto;
            position:relative;
            display:inline-block;
        }

        .logo-inner{
            position:absolute;
            top:50%;
            left:50%;
            transform:translate(-50%,-50%);
            width:100%;
            height:100%;
            display:flex;
            align-items:center;
            justify-content:center;
            transition: opacity 1s ease;
            opacity:0;
            pointer-events:none;
        }

        .logo-inner.visible{
            opacity:1;
            pointer-events:auto;
        }

        .logo-inner svg{
            width:100%;
            height:100%;
            max-height:70px;
            max-width:160px;
            display:block;
        }

        /* Specific CSS override for the Cloud logo:
           - Change its color to #080a33 via CSS (does not modify original SVG file)
           - Slightly reduce its rendered size to improve visual balance
        */
        .logo-inner.logo-cloud svg,
        .logo-inner.logo-cloud svg * {
            fill: #080a33 !important;
            stroke: #080a33 !important;
        }
        .logo-inner.logo-cloud svg{
            width:85%;
            height:85%;
            transform-origin:center;
        }

        main{
            padding:30px 20px;
            max-width:1200px;
            margin:0 auto;
        }

        .section-title{
            font-family:'Poppins-Bold', sans-serif;
            font-size:2em;
            margin:20px 0;
            text-align:center;
            color:#000;
        }

        .icon-buttons-container{
            display:flex;
            justify-content:center;
            gap:20px;
            flex-wrap:wrap;
            margin-bottom:10px;
        }

        .icon-button{
            font-family:'Poppins-Bold', sans-serif;
            display:flex;
            flex-direction:column;
            align-items:center;
            justify-content:center;
            width:180px;
            height:140px;
            border-radius:12px;
            text-decoration:none;
            font-weight:700;
            transition: transform .25s, box-shadow .25s, opacity .25s;
            box-shadow:0 4px 8px rgba(0,0,0,0.08);
            gap:8px;
            text-align:center;
        }

        .icon-button i{ font-size:2.2em; }

        /* Reclutamiento button (DTO reclutamiento) */
        .icon-button.reclutamiento{
            background: var(--reclutamiento-bg);
            color: var(--reclutamiento-text);
            border: 1px solid var(--reclutamiento-bg);
        }

        /* Comercial protected button (still uses modal access) */
        .icon-button.comercial.protected{
            background: var(--comercial-bg);
            color: var(--comercial-text);
            border: 1px solid var(--comercial-bg);
            cursor:pointer;
        }

        /* New commercial CH button (plain link to ch.html) */
        .icon-button.comercial.ch {
            background: #c0caff; /* requested */
            color: #061bb0; /* requested */
            border: 1px solid #c0caff;
        }

        .icon-button:hover{ transform: translateY(-6px); box-shadow:0 10px 20px rgba(0,0,0,0.12); }

        /* Employees list */
        .employees-section{ margin-top:30px; }
        .employees-list{
            display:flex;
            flex-direction:column;
            gap:0;
            border-radius:8px;
            overflow:hidden;
            background: rgba(0,0,0,0.03);
            border:1px solid rgba(0,0,0,0.06);
        }
        .employee-card{
            padding:14px 18px;
            display:flex;
            flex-direction:column;
            align-items:center;
            text-align:center;
            border-bottom:1px solid rgba(0,0,0,0.06);
        }
        .employee-card:last-child{ border-bottom:none; }
        .employee-name{ font-family:'Poppins-Bold', sans-serif; font-weight:700; margin-bottom:6px; color:#000; }
        .employee-role{ display:flex; align-items:center; gap:8px; color: rgba(0,0,0,0.7); font-family:'Poppins-Regular', sans-serif; }

        .status-dot{ width:10px; height:10px; border-radius:50%; display:inline-block; }

        /* legacy classes kept but colors will be set inline based on role+unit */
        .dot-comercial{ background:#0d4c7f; box-shadow:0 0 8px rgba(13,76,127,0.35); }
        .dot-reclutamiento{ background:#7fcfda; box-shadow:0 0 8px rgba(127,207,218,0.35); }

        /* Highlight primary role in multi-role rows */
        .employee-role .primary-role{
            font-family:'Poppins-Bold', sans-serif;
            font-weight:800;
            font-size:1.02em;
            color: #000;
        }

        /* Calendar / schedule */
        .schedule-container{ text-align:center; margin-top:30px; }
        .schedule-button{
            font-family:'Poppins-Bold', sans-serif;
            padding:18px 30px;
            border-radius:8px;
            border:1px solid rgba(0,0,0,0.08);
            background: rgba(0,0,0,0.04);
            color:#000;
            cursor:pointer;
            font-weight:700;
            display:inline-flex;
            align-items:center;
            gap:10px;
        }
        .calendar-wrapper{
            display:none;
            margin-top:16px;
            padding:18px;
            max-width:680px;
            margin-left:auto;
            margin-right:auto;
            background: rgba(0,0,0,0.03);
            border-radius:12px;
            border:1px solid rgba(0,0,0,0.06);
        }
        .calendar { display:grid; grid-template-columns:repeat(7,1fr); gap:6px; }

        .day-name{ font-family:'Poppins-Bold',sans-serif; padding:8px 0; color: rgba(0,0,0,0.65); border-bottom:2px solid rgba(0,0,0,0.06); }
        .day{ padding:12px; border-radius:6px; background: rgba(0,0,0,0.03); }
        .day.day-off{ background: rgba(220,53,69,0.16); color:#8B0000; font-weight:700; box-shadow:0 0 5px rgba(220,53,69,0.18); }

        /* Portal section */
        .portal-section{ margin-top:40px; display:flex; flex-direction:column; align-items:center; }
        .button-container{ display:flex; gap:20px; flex-wrap:wrap; justify-content:center; }

        .portal-button{
            font-family:'Poppins-Bold', sans-serif;
            display:flex;
            flex-direction:column;
            align-items:center;
            justify-content:center;
            padding:22px 24px;
            border-radius:8px;
            text-decoration:none;
            font-weight:700;
            font-size:1em;
            transition: transform .25s, box-shadow .25s, background .25s;
            box-shadow:0 6px 14px rgba(0,0,0,0.08);
            width:250px;
            height:120px;
            text-align:center;
            background: var(--portal-bg); /* Requirement: all portal buttons background #080a33 */
            color: var(--portal-text); /* Requirement: buttons text/icons #f1efee */
            border: none;
        }
        .portal-button i{ font-size:2.2em; color:inherit; margin-bottom:8px; }

        .portal-button:hover{ transform: translateY(-6px); box-shadow:0 12px 26px rgba(0,0,0,0.12); opacity:0.98; }

        /* Modal */
        .modal-overlay{ position:fixed; inset:0; display:none; align-items:center; justify-content:center; background: rgba(0,0,0,0.45); z-index:2000; }
        .modal-content{ width:90%; max-width:420px; background:#fff; padding:24px; border-radius:14px; box-shadow:0 10px 40px rgba(0,0,0,0.25); text-align:center; color:#000; }
        .modal-content h3{ margin:0 0 8px 0; font-family:'Poppins-Bold',sans-serif; font-size:1.2em; }
        .modal-input{ width:100%; padding:10px 12px; border-radius:8px; border:1px solid rgba(0,0,0,0.12); box-sizing:border-box; margin-top:8px; }
        .modal-buttons{ display:flex; gap:12px; justify-content:center; margin-top:14px; flex-wrap:wrap; }
        .modal-btn{ padding:10px 18px; border-radius:8px; border:none; cursor:pointer; font-family:'Poppins-Bold',sans-serif; }
        .modal-btn.confirm-btn{ background:#0d4c7f; color:#fff; }
        .modal-btn.cancel-btn{ background: rgba(0,0,0,0.06); color:#000; }

        footer{
            margin-top:40px;
            padding:18px 12px;
            text-align:center;
            background:#0d0d1a;
            color: #f1efee; /* Requirement: footer text color #f1efee */
            font-family:'Poppins-Regular',sans-serif;
        }

        /* Responsive */
        @media (max-width:720px){
            .icon-button{ width:100%; max-width:420px; }
            .portal-button{ width:100%; max-width:420px; }
            .logo-container{ width:140px; height:60px; }
        }
    </style>
</head>
<body>
    <header>
        <div class="logo-container" aria-hidden="false" id="logo-container">
            <!-- JS will inject inline SVG markup here for both logos and alternate them -->
        </div>
    </header>

    <main>
        <div class="icon-buttons-container">
            <!-- DTO reclutamiento (renamed) -->
            <a href="https://novaklar.github.io/reclutamiento/" class="icon-button reclutamiento" id="reclutamiento-btn" aria-label="DTO reclutamiento">
                <i class="fas fa-user-plus" aria-hidden="true"></i>
                <span>DTO<br>reclutamiento</span>
            </a>

            <!-- DTO comercial protected (renamed) — keeps the password modal behavior -->
            <a href="#" id="comercial-btn" class="icon-button comercial protected" aria-label="DTO comercial (protegido)">
                <i class="fas fa-chart-bar" aria-hidden="true"></i>
                <span>DTO<br>comercial</span>
            </a>

            <!-- New DTO comercial linking to ch.html with requested colors -->
            <a href="ch.html" class="icon-button comercial ch" id="comercial-ch-btn" aria-label="DTO comercial">
                <i class="fas fa-chart-bar" aria-hidden="true"></i>
                <span>DTO<br>comercial</span>
            </a>
        </div>

        <h2 class="section-title">Empleados activos</h2>
        <section class="employees-section">
            <div id="employeesList" class="employees-list"></div>
        </section>

        <section class="schedule-container">
            <button id="show-calendar-btn" class="schedule-button">
                <i class="fas fa-calendar-alt"></i> Horario de descanso
            </button>

            <div id="calendar-wrapper" class="calendar-wrapper" aria-hidden="true">
                <div class="calendar-header" style="margin-bottom:12px;">
                    <h3 id="current-month"></h3>
                    <div class="employee-select-container" style="display:flex;align-items:center;gap:10px;justify-content:center;">
                        <label for="employee-select" style="font-family:'Poppins-Bold',sans-serif;color:#000;">Empleado:</label>
                        <select id="employee-select" style="padding:8px;border-radius:6px;border:1px solid rgba(0,0,0,0.14);background:#fff;">
                            <option value="" disabled selected>Seleccione</option>
                            <option value="katherin">Katherin</option>
                            <option value="neyereth">Neyereth</option>
                            <option value="luz">Luz</option>
                            <option value="ester">Ester</option>
                        </select>
                    </div>
                </div>

                <div id="calendar" class="calendar" aria-hidden="true">
                    <div class="day-name">Lun</div>
                    <div class="day-name">Mar</div>
                    <div class="day-name">Mié</div>
                    <div class="day-name">Jue</div>
                    <div class="day-name">Vie</div>
                    <div class="day-name">Sáb</div>
                    <div class="day-name">Dom</div>
                </div>
            </div>
        </section>

        <section class="portal-section">
            <h2 class="section-title">Portal de empleados</h2>
            <div class="button-container">
                <!-- Replaced "Líder comercial" by "Administrador" (keeps href as before) -->
                <a href="lider.html" class="portal-button administrador" id="administrador-btn" title="Administrador">
                    <i class="fas fa-user-tie" aria-hidden="true"></i>
                    Administrador
                </a>

                <!-- Existing asesor comercial button (keeps label) -->
                <a href="ventas.html" class="portal-button asesor-comercial" title="Asesor comercial">
                    <i class="fas fa-chart-line" aria-hidden="true"></i>
                    Asesor comercial
                </a>

                <!-- Asesor de reclutamiento button -->
                <a href="reclu.html" class="portal-button reclutamiento-portal" title="Asesor de reclutamiento">
                    <i class="fas fa-users" aria-hidden="true"></i>
                    Asesor de reclutamiento
                </a>

                <!-- New Planner M&T -->
                <a href="mt.html" class="portal-button planner-mt" title="Planner M&T">
                    <i class="fas fa-calendar-check" aria-hidden="true"></i>
                    Planner M&amp;T
                </a>

                <!-- New Planner R&R -->
                <a href="rr.html" class="portal-button planner-rr" title="Planner R&amp;R">
                    <i class="fas fa-calendar-alt" aria-hidden="true"></i>
                    Planner R&amp;R
                </a>
            </div>
        </section>
    </main>

    <footer>
        <p>&copy; 2025 Novaklar. Todos los derechos reservados.</p>
    </footer>

    <!-- Password modal for protected commercial button -->
    <div id="password-modal" class="modal-overlay" aria-hidden="true">
        <div class="modal-content" role="dialog" aria-modal="true" aria-labelledby="modal-title">
            <h3 id="modal-title">Acceso al Departamento Comercial</h3>
            <p>Introduce la contraseña para continuar:</p>
            <input type="password" id="password-input" class="modal-input" placeholder="Contraseña" aria-label="Contraseña"/>
            <div id="modal-error-message" style="color:#ff4d4d;margin-top:6px;min-height:18px;"></div>
            <div class="modal-buttons">
                <button id="confirm-password-btn" class="modal-btn confirm-btn">Acceder</button>
                <button id="cancel-password-btn" class="modal-btn cancel-btn">Cancelar</button>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            /* -------------------------
               Header logos rotating
               - Cloud logo color adjusted via CSS (no modification of original SVG file).
               - Cloud logo slightly reduced in size via CSS.
               ------------------------- */
            const logoContainer = document.getElementById('logo-container');

            // URLs provided by the user
            const logoUrls = [
                'https://raw.githubusercontent.com/novaklar/web/refs/heads/main/cloud.svg', // initial (cloud)
                'https://raw.githubusercontent.com/novaklar/web/refs/heads/main/hanabi.svg' // secondary
            ];

            // We'll fetch the raw SVG markup and inject inline SVGs so we can recolor via CSS.
            // Important: we NO LONGER replace fill/stroke in the fetched SVG text.
            // Instead we add a wrapper class for the cloud logo and use CSS to override fills/strokes.
            async function loadAndInjectLogos() {
                const fragments = [];
                for (let i = 0; i < logoUrls.length; i++) {
                    try {
                        const res = await fetch(logoUrls[i]);
                        let svgText = await res.text();

                        // Some raw SVGs might come with XML prolog or doctype, strip anything before <svg
                        const svgStart = svgText.indexOf('<svg');
                        if (svgStart > 0) svgText = svgText.substring(svgStart);

                        // Ensure the root <svg ...> has aria-hidden and role attributes for accessibility
                        svgText = svgText.replace(/<svg([^>]*)>/, '<svg$1 role="img" aria-hidden="true">');

                        // Create wrapper
                        const wrapper = document.createElement('div');
                        wrapper.classList.add('logo-inner');

                        // Mark the first (cloud) logo so we can recolor and resize via CSS without editing the SVG file
                        if (i === 0) wrapper.classList.add('logo-cloud');

                        wrapper.innerHTML = svgText;
                        fragments.push(wrapper);
                    } catch (err) {
                        // If fetch fails, fallback to an <img> with given URL (less control over color)
                        const wrapper = document.createElement('div');
                        wrapper.classList.add('logo-inner');
                        if (i === 0) wrapper.classList.add('logo-cloud');
                        wrapper.innerHTML = '<img src="' + logoUrls[i] + '" alt="" style="width:100%;height:100%;object-fit:contain;"/>';
                        fragments.push(wrapper);
                        console.error('Error loading SVG:', logoUrls[i], err);
                    }
                }

                // Inject into DOM
                fragments.forEach((el, idx) => {
                    // First element visible initially
                    if (idx === 0) el.classList.add('visible');
                    logoContainer.appendChild(el);
                });

                // Start rotation: alternate every 4 seconds with fade transition via CSS
                if (fragments.length > 1) {
                    let current = 0;
                    setInterval(() => {
                        const total = fragments.length;
                        const next = (current + 1) % total;
                        fragments[current].classList.remove('visible');
                        fragments[next].classList.add('visible');
                        current = next;
                    }, 4000); // 4000ms = 4s as requested
                }
            }

            loadAndInjectLogos();

            /* -------------------------
               Buttons / Modal logic
               ------------------------- */
            const comercialBtn = document.getElementById('comercial-btn'); // protected DTO comercial
            const passwordModal = document.getElementById('password-modal');
            const passwordInput = document.getElementById('password-input');
            const confirmPasswordBtn = document.getElementById('confirm-password-btn');
            const cancelPasswordBtn = document.getElementById('cancel-password-btn');
            const modalErrorMessage = document.getElementById('modal-error-message');

            const CORRECT_PASSWORD = "200823";
            const LOCAL_STORAGE_KEY = "novaklar_comercial_access";

            // Protected DTO comercial behavior (shows modal unless already unlocked)
            comercialBtn.addEventListener('click', function(e) {
                e.preventDefault();
                const stored = localStorage.getItem(LOCAL_STORAGE_KEY);
                if (stored === CORRECT_PASSWORD) {
                    window.location.href = "comercial.html";
                    return;
                }
                // open modal
                passwordModal.style.display = 'flex';
                passwordModal.setAttribute('aria-hidden', 'false');
                passwordInput.focus();
            });

            function handlePasswordCheck() {
                const val = passwordInput.value || '';
                if (val === CORRECT_PASSWORD) {
                    localStorage.setItem(LOCAL_STORAGE_KEY, val);
                    window.location.href = "comercial.html";
                } else {
                    modalErrorMessage.textContent = "Contraseña incorrecta. Inténtalo de nuevo.";
                    passwordInput.value = "";
                    passwordInput.focus();
                }
            }

            confirmPasswordBtn.addEventListener('click', handlePasswordCheck);
            passwordInput.addEventListener('keydown', function(ev) {
                if (ev.key === 'Enter') handlePasswordCheck();
            });

            function closeModal() {
                passwordModal.style.display = 'none';
                passwordModal.setAttribute('aria-hidden', 'true');
                passwordInput.value = "";
                modalErrorMessage.textContent = "";
            }

            cancelPasswordBtn.addEventListener('click', function() {
                closeModal();
            });

            passwordModal.addEventListener('click', function(ev) {
                if (ev.target === passwordModal) closeModal();
            });

            /* -------------------------
               Fetch employees and render list
               - Aggregate multiple cargos per person into one row
               - Replace role "Líder comercial" by "Administrador"
               - Apply colors per role+unidad (NK/HB) as requested
               - Highlight primary role based on hierarchy:
                 1. Administrador
                 2. Planner
                 3. Asesor comercial
                 4. Asesor de reclutamiento
               ------------------------- */
            (function loadEmployees() {
                const spreadsheetId = '1l2Ge_RZ698FQgRbaPxGUd8a2SLN_CA2t4rPlVWA3Mw';
                const queryUrl = `https://docs.google.com/spreadsheets/d/${spreadsheetId}/gviz/tq?tqx=out:json&tq=SELECT B, C`;
                const employeesList = document.getElementById('employeesList');

                // Helper: determine base role and unit
                function parseRoleUnit(rawRole) {
                    if (!rawRole) return { role: '', unit: null };
                    let role = rawRole.trim();
                    // Normalize some known variants
                    if (/Líder\s+comercial/i.test(role)) {
                        role = role.replace(/Líder\s+comercial/i, 'Administrador');
                    }
                    // Detect unit tokens NK or HB (case-insensitive)
                    const unitMatch = role.match(/\b(NK|HB)\b/i);
                    const unit = unitMatch ? unitMatch[0].toUpperCase() : null;
                    // Remove unit token from the visible role (but keep original role text for display)
                    const baseRole = role.replace(/\b(NK|HB)\b/i, '').replace(/\s+$/, '').trim();
                    // For planners, unify to 'Planner' as base
                    const normalizedBase = (/planner/i.test(baseRole)) ? 'Planner' :
                                           (/administrador/i.test(baseRole)) ? 'Administrador' :
                                           (/asesor\s+comercial/i.test(baseRole)) ? 'Asesor comercial' :
                                           (/asesor\s+de\s+reclutamiento/i.test(baseRole)) ? 'Asesor de reclutamiento' :
                                           baseRole;
                    return { role: normalizedBase, unit: unit, display: role };
                }

                // Ranking for hierarchy: lower number = higher priority
                const roleRank = {
                    'Administrador': 1,
                    'Planner': 2,
                    'Asesor comercial': 3,
                    'Asesor de reclutamiento': 4
                };

                // Determine color per role+unit per spec
                function getColorForRoleAndUnit(role, unit) {
                    // Default unit to 'NK' when not provided
                    const u = unit ? unit.toUpperCase() : 'NK';
                    if (role === 'Administrador') {
                        return (u === 'HB') ? '#c0caff' : '#7fcfda';
                    }
                    if (role === 'Planner') {
                        return '#0d4c7f';
                    }
                    if (role === 'Asesor comercial') {
                        return (u === 'HB') ? '#061bb0' : '#0d4c7f';
                    }
                    if (role === 'Asesor de reclutamiento') {
                        return (u === 'HB') ? '#061bb0' : '#0d4c7f';
                    }
                    // fallback
                    return '#0d4c7f';
                }

                // Convert HEX to rgba for box-shadow
                function hexToRgba(hex, alpha) {
                    const h = hex.replace('#', '');
                    const bigint = parseInt(h.length === 3 ? h.split('').map(c => c + c).join('') : h, 16);
                    const r = (bigint >> 16) & 255;
                    const g = (bigint >> 8) & 255;
                    const b = bigint & 255;
                    return `rgba(${r}, ${g}, ${b}, ${alpha})`;
                }

                fetch(queryUrl)
                    .then(r => r.text())
                    .then(text => {
                        // parse the JSON from Google spreadsheets gviz response
                        const jsonString = text.substring(text.indexOf('{'), text.lastIndexOf('}') + 1);
                        const data = JSON.parse(jsonString);
                        const rows = (data.table && data.table.rows) || [];

                        // Aggregate roles by name
                        const map = {}; // name -> array of role display strings (as they appear) + parsed info
                        rows.forEach(row => {
                            const name = row.c?.[0]?.v?.toString()?.trim();
                            let rawRole = row.c?.[1]?.v?.toString()?.trim();
                            if (!name || !rawRole) return;

                            // Normalize Líder comercial -> Administrador (in rawRole)
                            rawRole = rawRole.replace(/Líder\s+comercial/ig, 'Administrador');

                            // Some entries might include multiple roles separated by commas or slashes -> split them
                            // But preserve the original tokens including unit markers
                            const parts = rawRole.split(/\s*[,\/]\s*/).filter(Boolean);

                            parts.forEach(p => {
                                const parsed = parseRoleUnit(p);
                                if (!map[name]) map[name] = [];
                                // Avoid duplicate identical role+unit entries
                                const exists = map[name].some(item => item.display.toLowerCase() === parsed.display.toLowerCase());
                                if (!exists) map[name].push(parsed);
                            });
                        });

                        // Now convert map to array of employees
                        const employees = Object.keys(map).map(name => ({ name, roles: map[name] }));

                        // Render
                        employees.forEach(emp => {
                            const card = document.createElement('div');
                            card.className = 'employee-card';

                            const nameEl = document.createElement('div');
                            nameEl.className = 'employee-name';
                            nameEl.textContent = emp.name;

                            const roleEl = document.createElement('div');
                            roleEl.className = 'employee-role';

                            const dot = document.createElement('span');
                            dot.className = 'status-dot';

                            // Choose primary role by hierarchy ranking:
                            // If multiple roles have same highest rank, prefer NK unit if present, else HB.
                            let primary = emp.roles[0];
                            emp.roles.forEach(r => {
                                const rankR = roleRank[r.role] || 99;
                                const rankP = roleRank[primary.role] || 99;
                                if (rankR < rankP) {
                                    primary = r;
                                } else if (rankR === rankP) {
                                    // tie-breaker: prefer NK over HB if roles have unit info
                                    if ((r.unit === 'NK' && primary.unit !== 'NK')) {
                                        primary = r;
                                    }
                                }
                            });

                            // Determine color for dot based on primary role+unit
                            const color = getColorForRoleAndUnit(primary.role, primary.unit);
                            dot.style.background = color;
                            dot.style.boxShadow = `0 0 8px ${hexToRgba(color, 0.35)}`;

                            roleEl.appendChild(dot);

                            // Create role text nodes: show all roles, highlight primary
                            // Display each role using its original display string if present; if not, build a readable label
                            const roleTextContainer = document.createElement('div');
                            roleTextContainer.style.display = 'inline-flex';
                            roleTextContainer.style.flexWrap = 'wrap';
                            roleTextContainer.style.gap = '6px';
                            emp.roles.forEach((r, idx) => {
                                const span = document.createElement('span');
                                // Use display (which includes unit token if provided), otherwise construct label
                                const displayLabel = r.display || (r.role + (r.unit ? ' ' + r.unit : ''));
                                span.textContent = displayLabel;
                                if (r.role === primary.role && ( (r.unit || null) === (primary.unit || null) || r.display.toLowerCase() === primary.display.toLowerCase() )) {
                                    span.classList.add('primary-role');
                                } else {
                                    span.style.opacity = '0.95';
                                }
                                // Join roles with slash if there are multiple (visual separator taken care by gap)
                                roleTextContainer.appendChild(span);
                                if (idx < emp.roles.length - 1) {
                                    const sep = document.createElement('span');
                                    sep.textContent = '/';
                                    sep.style.opacity = '0.6';
                                    roleTextContainer.appendChild(sep);
                                }
                            });

                            roleEl.appendChild(roleTextContainer);

                            card.appendChild(nameEl);
                            card.appendChild(roleEl);
                            employeesList.appendChild(card);
                        });

                        // If no employees found, keep existing friendly fallback
                        if (employees.length === 0) {
                            const fallback = document.createElement('div');
                            fallback.className = 'employee-card';
                            fallback.textContent = 'No se encontraron empleados.';
                            document.getElementById('employeesList').appendChild(fallback);
                        }
                    })
                    .catch(err => {
                        console.error('Error fetching employees:', err);
                        // Optionally, show a friendly message
                        const fallback = document.createElement('div');
                        fallback.className = 'employee-card';
                        fallback.textContent = 'No se pudieron cargar los empleados en este momento.';
                        document.getElementById('employeesList').appendChild(fallback);
                    });
            })();

            /* -------------------------
               Calendar / Schedule logic (kept mostly as originally provided)
               ------------------------- */
            const showCalendarBtn = document.getElementById('show-calendar-btn');
            const calendarWrapper = document.getElementById('calendar-wrapper');
            const calendarEl = document.getElementById('calendar');
            const currentMonthEl = document.getElementById('current-month');
            const employeeSelect = document.getElementById('employee-select');

            const descansoData = {
                katherin: [3,5],
                neyereth: [3,5],
                luz: [1,4],
                ester: [6,0]
            };

            showCalendarBtn.addEventListener('click', function(e){
                e.stopPropagation();
                const isVisible = calendarWrapper.style.display === 'block';
                calendarWrapper.style.display = isVisible ? 'none' : 'block';
                calendarWrapper.setAttribute('aria-hidden', isVisible ? 'true' : 'false');
                if (!isVisible) generateCalendar(employeeSelect.value);
            });

            employeeSelect.addEventListener('change', function(){
                generateCalendar(employeeSelect.value);
            });

            document.addEventListener('click', function(e){
                if (calendarWrapper.style.display === 'block' && !calendarWrapper.contains(e.target) && e.target !== showCalendarBtn) {
                    calendarWrapper.style.display = 'none';
                }
            });

            function generateCalendar(selectedEmployee) {
                calendarEl.innerHTML = `
                    <div class="day-name">Lun</div>
                    <div class="day-name">Mar</div>
                    <div class="day-name">Mié</div>
                    <div class="day-name">Jue</div>
                    <div class="day-name">Vie</div>
                    <div class="day-name">Sáb</div>
                    <div class="day-name">Dom</div>
                `;

                const today = new Date();
                const month = today.getMonth();
                const year = today.getFullYear();
                currentMonthEl.textContent = today.toLocaleString('es-ES', { month: 'long', year: 'numeric' });

                const firstDayOfMonth = new Date(year, month, 1).getDay();
                const daysInMonth = new Date(year, month + 1, 0).getDate();
                const startDay = firstDayOfMonth === 0 ? 6 : firstDayOfMonth - 1;

                for (let i = 0; i < startDay; i++) {
                    const emptyDay = document.createElement('div');
                    emptyDay.classList.add('day');
                    calendarEl.appendChild(emptyDay);
                }

                for (let i = 1; i <= daysInMonth; i++) {
                    const dayEl = document.createElement('div');
                    dayEl.classList.add('day');
                    dayEl.textContent = i;

                    const dayOfWeek = new Date(year, month, i).getDay();
                    const descansoDays = (descansoData[selectedEmployee] || []);
                    if (descansoDays.includes(dayOfWeek)) {
                        dayEl.classList.add('day-off');
                        dayEl.title = 'Día de descanso';
                    }
                    calendarEl.appendChild(dayEl);
                }
            }
            generateCalendar('');

            /* End DOMContentLoaded */
        });
    </script>
</body>
</html>
