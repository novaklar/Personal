<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>Novaklar Portal</title>
    <link rel="preconnect" href="https://fonts.googleapis.com"/>
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin/>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;700&display=swap" rel="stylesheet"/>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css"/>
    <style>
        @font-face {
            font-family: 'Poppins-Bold';
            src: url('https://raw.githubusercontent.com/novaklar/web/main/Poppins-Bold.ttf') format('truetype');
            font-weight: 700;
            font-style: normal;
        }

        @font-face {
            font-family: 'Poppins-Regular';
            src: url('https://raw.githubusercontent.com/novaklar/web/main/Poppins-Regular.ttf') format('truetype');
            font-weight: 400;
            font-style: normal;
        }

        :root{
            --accent-dark: #080a33; /* used for logos and portal bg */
            --portal-bg: #080a33;
            --portal-text: #f1efee;
            --page-bg: #f1efee;
            --reclutamiento-bg: #7fcfda;
            --reclutamiento-text: #0d4c7f;
            --comercial-bg: #0d4c7f;
            --comercial-text: #7fcfda;
        }

        /* General styles */
        html,body{
            margin:0;
            padding:0;
            font-family: 'Poppins-Regular', sans-serif;
            background-color: var(--page-bg); /* Requirement: general background #f1efee */
            color: #000;
            -webkit-font-smoothing:antialiased;
            -moz-osx-font-smoothing:grayscale;
        }

        /* Header: solid background and slightly reduced height */
        header{
            position:sticky;
            top:0;
            z-index:1000;
            padding:6px 0; /* reduced slightly from 10px */
            text-align:center;
            background: #f1efee; /* solid background as requested */
        }

        /* Logo container: will hold two inline SVGs that alternate */
        .logo-container{
            width:150px;
            height:64px;
            margin:0 auto;
            position:relative;
            display:inline-block;
        }

        .logo-inner{
            position:absolute;
            top:50%;
            left:50%;
            transform:translate(-50%,-50%);
            width:100%;
            height:100%;
            display:flex;
            align-items:center;
            justify-content:center;
            transition: opacity 1s ease;
            opacity:0;
            pointer-events:none;
        }

        .logo-inner.visible{
            opacity:1;
            pointer-events:auto;
        }

        .logo-inner svg{
            width:100%;
            height:100%;
            max-height:64px;
            max-width:150px;
            display:block;
        }

        /* Specific CSS override for the Cloud logo */
        .logo-inner.logo-cloud svg,
        .logo-inner.logo-cloud svg * {
            fill: #080a33 !important;
            stroke: #080a33 !important;
        }
        .logo-inner.logo-cloud svg{
            width:85%;
            height:85%;
            transform-origin:center;
        }

        main{
            padding:30px 20px;
            max-width:1200px;
            margin:0 auto;
        }

        .section-title{
            font-family:'Poppins-Bold', sans-serif;
            font-size:2em;
            margin:20px 0;
            text-align:center;
            color:#000;
        }

        .icon-buttons-container{
            display:flex;
            justify-content:center;
            gap:20px;
            flex-wrap:wrap;
            margin-bottom:10px;
        }

        .icon-button{
            font-family:'Poppins-Bold', sans-serif;
            display:flex;
            flex-direction:column;
            align-items:center;
            justify-content:center;
            width:180px;
            height:140px;
            border-radius:12px;
            text-decoration:none;
            font-weight:700;
            transition: transform .25s, box-shadow .25s, opacity .25s;
            box-shadow:0 4px 8px rgba(0,0,0,0.08);
            gap:8px;
            text-align:center;
        }

        .icon-button i{ font-size:2.2em; }

        /* Reclutamiento button (DTO reclutamiento) */
        .icon-button.reclutamiento{
            background: var(--reclutamiento-bg);
            color: var(--reclutamiento-text);
            border: 1px solid var(--reclutamiento-bg);
        }

        /* Comercial protected button (still uses modal access) */
        .icon-button.comercial.protected{
            background: var(--comercial-bg);
            color: var(--comercial-text);
            border: 1px solid var(--comercial-bg);
            cursor:pointer;
        }

        /* New commercial CH button (plain link to ch.html) */
        .icon-button.comercial.ch {
            background: #c0caff; /* requested */
            color: #061bb0; /* requested */
            border: 1px solid #c0caff;
        }

        .icon-button:hover{ transform: translateY(-6px); box-shadow:0 10px 20px rgba(0,0,0,0.12); }

        /* Employees list */
        .employees-section{ margin-top:30px; }
        .employees-list{
            display:flex;
            flex-direction:column;
            gap:0;
            border-radius:8px;
            overflow:hidden;
            background: rgba(0,0,0,0.03);
            border:1px solid rgba(0,0,0,0.06);
        }
        .employee-card{
            padding:14px 18px;
            display:flex;
            flex-direction:column;
            align-items:center; /* overall card centered */
            text-align:center;
            border-bottom:1px solid rgba(0,0,0,0.06);
        }
        .employee-card:last-child{ border-bottom:none; }

        /* Name row: indicator aligned left next to name. Name on top; roles shown below */
        .name-row{
            display:flex;
            align-items:center;
            gap:10px;
            justify-content:center; /* keep the pair centered within the card */
            width:100%;
            box-sizing:border-box;
        }

        .employee-name{
            font-family:'Poppins-Bold', sans-serif;
            font-weight:700;
            margin:0; /* name sits directly in the name-row */
            color:#000;
            text-align:left; /* text flows to right of icon */
        }

        /*
         Simple point indicator with ripple effect (ripple implemented reliably):
         - Keeps same size/space as previous (12x12)
         - Positioned left next to name (no layout changes)
         - Color controlled via inline CSS variables set by JS (per role)
         - Ripple implemented with ::after, subtle, fluid, infinite
         - Important fix: ensure the dot is on top (z-index:1) and ripple below (z-index:0) so ripple is visible
        */
        .status-dot{
            width:12px;
            height:12px;
            min-width:12px;
            min-height:12px;
            display:inline-block;
            border-radius:50%;
            position:relative;
            flex: 0 0 auto;
            background: var(--dot-color, #0d4c7f);
            box-shadow: 0 0 6px var(--dot-rgba, rgba(13,76,127,0.18));
            z-index: 1; /* ensure dot sits above the ripple */
        }

        .status-dot::after{
            content: '';
            position: absolute;
            left: 50%;
            top: 50%;
            transform: translate(-50%,-50%) scale(1);
            width: 100%;
            height: 100%;
            border-radius: 50%;
            background: var(--dot-color, #0d4c7f);
            box-shadow: 0 0 8px var(--dot-rgba, rgba(13,76,127,0.22));
            opacity: 0.9;
            z-index: 0; /* ripple underneath the dot */
            pointer-events: none;
            animation: ripple 2s infinite ease-out;
            -webkit-animation: ripple 2s infinite ease-out;
            transform-origin: center;
            will-change: transform, opacity;
        }

        @keyframes ripple {
            0% {
                transform: translate(-50%,-50%) scale(1);
                opacity: 0.9;
            }
            70% {
                transform: translate(-50%,-50%) scale(2.2);
                opacity: 0.15;
            }
            100% {
                transform: translate(-50%,-50%) scale(2.6);
                opacity: 0;
            }
        }
        @-webkit-keyframes ripple {
            0% {
                -webkit-transform: translate(-50%,-50%) scale(1);
                opacity: 0.9;
            }
            70% {
                -webkit-transform: translate(-50%,-50%) scale(2.2);
                opacity: 0.15;
            }
            100% {
                -webkit-transform: translate(-50%,-50%) scale(2.6);
                opacity: 0;
            }
        }

        /* Roles: primary below the name; secondary below primary.
           Always stacked vertically, centered horizontally.
           No separators, never in a single line.
        */
        .employee-role{
            display:flex;
            flex-direction:column;
            align-items:center;
            gap:6px;
            color: rgba(0,0,0,0.7);
            font-family:'Poppins-Regular',sans-serif;
            justify-content:center;
            margin-top:8px;
            width:100%;
            box-sizing:border-box;
        }

        .role-item{
            display:block;
            text-align:center;
            width:100%;
        }

        /* primary role emphasis */
        .employee-role .primary-role{
            font-family:'Poppins-Bold', sans-serif;
            font-weight:800;
            font-size:1.02em;
            color: #000;
        }

        /* On small screens: keep stacked roles and responsive sizes */
        @media (max-width:720px){
            .icon-button{ width:100%; max-width:420px; }
            .portal-button{ width:100%; max-width:420px; }
            .logo-container{ width:140px; height:60px; }

            .employee-role{
                gap:4px;
            }
        }

        /* Calendar / schedule */
        .schedule-container{ text-align:center; margin-top:30px; }
        .schedule-button{
            font-family:'Poppins-Bold', sans-serif;
            padding:18px 30px;
            border-radius:8px;
            border:1px solid rgba(0,0,0,0.08);
            background: rgba(0,0,0,0.04);
            color:#000;
            cursor:pointer;
            font-weight:700;
            display:inline-flex;
            align-items:center;
            gap:10px;
        }
        .calendar-wrapper{
            display:none;
            margin-top:16px;
            padding:18px;
            max-width:680px;
            margin-left:auto;
            margin-right:auto;
            background: rgba(0,0,0,0.03);
            border-radius:12px;
            border:1px solid rgba(0,0,0,0.06);
        }
        .calendar { display:grid; grid-template-columns:repeat(7,1fr); gap:6px; }

        .day-name{ font-family:'Poppins-Bold',sans-serif; padding:8px 0; color: rgba(0,0,0,0.65); border-bottom:2px solid rgba(0,0,0,0.06); }
        .day{ padding:12px; border-radius:6px; background: rgba(0,0,0,0.03); }
        .day.day-off{ background: rgba(220,53,69,0.16); color:#8B0000; font-weight:700; box-shadow:0 0 5px rgba(220,53,69,0.18); }

        /* Portal section */
        .portal-section{ margin-top:40px; display:flex; flex-direction:column; align-items:center; }
        .button-container{ display:flex; gap:20px; flex-wrap:wrap; justify-content:center; }

        .portal-button{
            font-family:'Poppins-Bold', sans-serif;
            display:flex;
            flex-direction:column;
            align-items:center;
            justify-content:center;
            padding:22px 24px;
            border-radius:8px;
            text-decoration:none;
            font-weight:700;
            font-size:1em;
            transition: transform .25s, box-shadow .25s, background .25s;
            box-shadow:0 6px 14px rgba(0,0,0,0.08);
            width:250px;
            height:120px;
            text-align:center;
            background: var(--portal-bg); /* Requirement: all portal buttons background #080a33 */
            color: var(--portal-text); /* Requirement: buttons text/icons #f1efee */
            border: none;
        }
        .portal-button i{ font-size:2.2em; color:inherit; margin-bottom:8px; }

        .portal-button:hover{ transform: translateY(-6px); box-shadow:0 12px 26px rgba(0,0,0,0.12); opacity:0.98; }

        /* Modal */
        .modal-overlay{ position:fixed; inset:0; display:none; align-items:center; justify-content:center; background: rgba(0,0,0,0.45); z-index:2000; }
        .modal-content{ width:90%; max-width:420px; background:#fff; padding:24px; border-radius:14px; box-shadow:0 10px 40px rgba(0,0,0,0.25); text-align:center; color:#000; }
        .modal-content h3{ margin:0 0 8px 0; font-family:'Poppins-Bold',sans-serif; font-size:1.2em; }
        .modal-input{ width:100%; padding:10px 12px; border-radius:8px; border:1px solid rgba(0,0,0,0.12); box-sizing:border-box; margin-top:8px; }
        .modal-buttons{ display:flex; gap:12px; justify-content:center; margin-top:14px; flex-wrap:wrap; }
        .modal-btn{ padding:10px 18px; border-radius:8px; border:none; cursor:pointer; font-family:'Poppins-Bold',sans-serif; }
        .modal-btn.confirm-btn{ background:#0d4c7f; color:#fff; }
        .modal-btn.cancel-btn{ background: rgba(0,0,0,0.06); color:#000; }

        footer{
            margin-top:40px;
            padding:18px 12px;
            text-align:center;
            background:#0d0d1a;
            color: #f1efee; /* Requirement: footer text color #f1efee */
            font-family:'Poppins-Regular',sans-serif;
        }

    </style>
</head>
<body>
    <header>
        <div class="logo-container" aria-hidden="false" id="logo-container">
            <!-- JS will inject inline SVG markup here for both logos and alternate them -->
        </div>
    </header>

    <main>
        <div class="icon-buttons-container">
            <!-- DTO reclutamiento (renamed) -->
            <a href="https://novaklar.github.io/reclutamiento/" class="icon-button reclutamiento" id="reclutamiento-btn" aria-label="DTO reclutamiento">
                <i class="fas fa-user-plus" aria-hidden="true"></i>
                <span>DTO<br>reclutamiento</span>
            </a>

            <!-- DTO comercial protected (renamed) — keeps the password modal behavior -->
            <a href="#" id="comercial-btn" class="icon-button comercial protected" aria-label="DTO comercial (protegido)">
                <i class="fas fa-chart-bar" aria-hidden="true"></i>
                <span>DTO<br>comercial</span>
            </a>

            <!-- New DTO comercial linking to ch.html with requested colors -->
            <a href="ch.html" class="icon-button comercial ch" id="comercial-ch-btn" aria-label="DTO comercial">
                <i class="fas fa-chart-bar" aria-hidden="true"></i>
                <span>DTO<br>comercial</span>
            </a>
        </div>

        <h2 class="section-title">Empleados activos</h2>
        <section class="employees-section">
            <div id="employeesList" class="employees-list"></div>
        </section>

        <section class="schedule-container">
            <button id="show-calendar-btn" class="schedule-button">
                <i class="fas fa-calendar-alt"></i> Horario de descanso
            </button>

            <div id="calendar-wrapper" class="calendar-wrapper" aria-hidden="true">
                <div class="calendar-header" style="margin-bottom:12px;">
                    <h3 id="current-month"></h3>
                    <div class="employee-select-container" style="display:flex;align-items:center;gap:10px;justify-content:center;">
                        <label for="employee-select" style="font-family:'Poppins-Bold',sans-serif;color:#000;">Empleado:</label>
                        <select id="employee-select" style="padding:8px;border-radius:6px;border:1px solid rgba(0,0,0,0.14);background:#fff;">
                            <option value="" disabled selected>Seleccione</option>
                        </select>
                    </div>
                </div>

                <div id="calendar" class="calendar" aria-hidden="true">
                    <div class="day-name">Lun</div>
                    <div class="day-name">Mar</div>
                    <div class="day-name">Mié</div>
                    <div class="day-name">Jue</div>
                    <div class="day-name">Vie</div>
                    <div class="day-name">Sáb</div>
                    <div class="day-name">Dom</div>
                </div>
            </div>
        </section>

        <section class="portal-section">
            <h2 class="section-title">Portal de empleados</h2>
            <div class="button-container">
                <!-- Replaced "Líder comercial" by "Administrador" (keeps href as before) -->
                <a href="lider.html" class="portal-button administrador" id="administrador-btn" title="Administrador">
                    <i class="fas fa-user-tie" aria-hidden="true"></i>
                    Administrador
                </a>

                <!-- Existing asesor comercial button (keeps label) -->
                <a href="ventas.html" class="portal-button asesor-comercial" title="Asesor comercial">
                    <i class="fas fa-chart-line" aria-hidden="true"></i>
                    Asesor comercial
                </a>

                <!-- Asesor de reclutamiento button name changed to "Reclutadores" (link & icon preserved) -->
                <a href="reclu.html" class="portal-button reclutamiento-portal" title="Reclutadores">
                    <i class="fas fa-users" aria-hidden="true"></i>
                    Reclutadores
                </a>

                <!-- New Planner M&T -->
                <a href="mt.html" class="portal-button planner-mt" title="Planner M&T">
                    <i class="fas fa-calendar-check" aria-hidden="true"></i>
                    Planner M&amp;T
                </a>

                <!-- New Planner R&R -->
                <a href="rr.html" class="portal-button planner-rr" title="Planner R&amp;R">
                    <i class="fas fa-calendar-alt" aria-hidden="true"></i>
                    Planner R&amp;R
                </a>
            </div>
        </section>
    </main>

    <footer>
        <p>&copy; 2025 Novaklar. Todos los derechos reservados.</p>
    </footer>

    <!-- Password modal for protected commercial button -->
    <div id="password-modal" class="modal-overlay" aria-hidden="true">
        <div class="modal-content" role="dialog" aria-modal="true" aria-labelledby="modal-title">
            <h3 id="modal-title">Acceso al Departamento Comercial</h3>
            <p>Introduce la contraseña para continuar:</p>
            <input type="password" id="password-input" class="modal-input" placeholder="Contraseña" aria-label="Contraseña"/>
            <div id="modal-error-message" style="color:#ff4d4d;margin-top:6px;min-height:18px;"></div>
            <div class="modal-buttons">
                <button id="confirm-password-btn" class="modal-btn confirm-btn">Acceder</button>
                <button id="cancel-password-btn" class="modal-btn cancel-btn">Cancelar</button>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            /* -------------------------
               Header logos rotating
               ------------------------- */
            const logoContainer = document.getElementById('logo-container');

            const logoUrls = [
                'https://raw.githubusercontent.com/novaklar/web/refs/heads/main/cloud.svg',
                'https://raw.githubusercontent.com/novaklar/web/refs/heads/main/hanabi.svg'
            ];

            async function loadAndInjectLogos() {
                const fragments = [];
                for (let i = 0; i < logoUrls.length; i++) {
                    try {
                        const res = await fetch(logoUrls[i]);
                        let svgText = await res.text();
                        const svgStart = svgText.indexOf('<svg');
                        if (svgStart > 0) svgText = svgText.substring(svgStart);
                        svgText = svgText.replace(/<svg([^>]*)>/, '<svg$1 role="img" aria-hidden="true">');
                        const wrapper = document.createElement('div');
                        wrapper.classList.add('logo-inner');
                        if (i === 0) wrapper.classList.add('logo-cloud');
                        wrapper.innerHTML = svgText;
                        fragments.push(wrapper);
                    } catch (err) {
                        const wrapper = document.createElement('div');
                        wrapper.classList.add('logo-inner');
                        if (i === 0) wrapper.classList.add('logo-cloud');
                        wrapper.innerHTML = '<img src="' + logoUrls[i] + '" alt="" style="width:100%;height:100%;object-fit:contain;"/>';
                        fragments.push(wrapper);
                        console.error('Error loading SVG:', logoUrls[i], err);
                    }
                }

                fragments.forEach((el, idx) => {
                    if (idx === 0) el.classList.add('visible');
                    logoContainer.appendChild(el);
                });

                if (fragments.length > 1) {
                    let current = 0;
                    setInterval(() => {
                        const total = fragments.length;
                        const next = (current + 1) % total;
                        fragments[current].classList.remove('visible');
                        fragments[next].classList.add('visible');
                        current = next;
                    }, 4000);
                }
            }

            loadAndInjectLogos();

            /* -------------------------
               Buttons / Modal logic
               ------------------------- */
            const comercialBtn = document.getElementById('comercial-btn');
            const passwordModal = document.getElementById('password-modal');
            const passwordInput = document.getElementById('password-input');
            const confirmPasswordBtn = document.getElementById('confirm-password-btn');
            const cancelPasswordBtn = document.getElementById('cancel-password-btn');
            const modalErrorMessage = document.getElementById('modal-error-message');

            const CORRECT_PASSWORD = "200823";
            const LOCAL_STORAGE_KEY = "novaklar_comercial_access";

            comercialBtn.addEventListener('click', function(e) {
                e.preventDefault();
                const stored = localStorage.getItem(LOCAL_STORAGE_KEY);
                if (stored === CORRECT_PASSWORD) {
                    window.location.href = "comercial.html";
                    return;
                }
                passwordModal.style.display = 'flex';
                passwordModal.setAttribute('aria-hidden', 'false');
                passwordInput.focus();
            });

            function handlePasswordCheck() {
                const val = passwordInput.value || '';
                if (val === CORRECT_PASSWORD) {
                    localStorage.setItem(LOCAL_STORAGE_KEY, val);
                    window.location.href = "comercial.html";
                } else {
                    modalErrorMessage.textContent = "Contraseña incorrecta. Inténtalo de nuevo.";
                    passwordInput.value = "";
                    passwordInput.focus();
                }
            }

            confirmPasswordBtn.addEventListener('click', handlePasswordCheck);
            passwordInput.addEventListener('keydown', function(ev) {
                if (ev.key === 'Enter') handlePasswordCheck();
            });

            function closeModal() {
                passwordModal.style.display = 'none';
                passwordModal.setAttribute('aria-hidden', 'true');
                passwordInput.value = "";
                modalErrorMessage.textContent = "";
            }

            cancelPasswordBtn.addEventListener('click', function() {
                closeModal();
            });

            passwordModal.addEventListener('click', function(ev) {
                if (ev.target === passwordModal) closeModal();
            });

            /* -------------------------
               Fetch employees and render list (GViz)
               Adjusted: use status-dot (ripple effect) instead of check.
               Roles stacked vertically (primary first), indicator left of name.
               ------------------------- */
            (function loadEmployees() {
                const spreadsheetId = '1l2Ge_RZ698FQgRbaPxGUd8aZ2SLN_CA2t4rPlVWA3Mw';
                const queryUrl = `https://docs.google.com/spreadsheets/d/${spreadsheetId}/gviz/tq?tqx=out:json&tq=select%20B,C,D,E,F`;
                const employeesList = document.getElementById('employeesList');
                const employeeSelect = document.getElementById('employee-select');

                function dayNameToGetDay(dayName) {
                    if (!dayName) return null;
                    const v = dayName.toString().trim().toLowerCase();
                    if (v.startsWith('lun')) return 1;
                    if (v.startsWith('mar')) return 2;
                    if (v.startsWith('mi') || v.startsWith('mié') || v.startsWith('mie') ) return 3;
                    if (v.startsWith('jue')) return 4;
                    if (v.startsWith('vie')) return 5;
                    if (v.startsWith('sáb') || v.startsWith('sab')) return 6;
                    if (v.startsWith('dom')) return 0;
                    if (v === 'monday') return 1;
                    if (v === 'tuesday') return 2;
                    if (v === 'wednesday') return 3;
                    if (v === 'thursday') return 4;
                    if (v === 'friday') return 5;
                    if (v === 'saturday') return 6;
                    if (v === 'sunday') return 0;
                    return null;
                }

                function parseRoleUnit(rawRole) {
                    if (!rawRole) return null;
                    let text = rawRole.toString().trim();
                    if (!text) return null;
                    text = text.replace(/Líder\s+comercial/ig, 'Administrador');
                    const unitMatch = text.match(/\b(NK|HB)\b/i);
                    const unit = unitMatch ? unitMatch[0].toUpperCase() : null;
                    let base = text;
                    if (/planner/i.test(text)) {
                        base = 'Planner';
                    } else if (/administrador/i.test(text)) {
                        base = 'Administrador';
                    } else if (/asesor\s+comercial/i.test(text)) {
                        base = 'Asesor comercial';
                    } else if (/reclutador/i.test(text)) {
                        base = 'Asesor de reclutamiento';
                    } else if (/asesor\s+de\s+reclutamiento/i.test(text)) {
                        base = 'Asesor de reclutamiento';
                    } else {
                        if (/comercial/i.test(text)) base = 'Asesor comercial';
                    }
                    const display = text;
                    return { role: base, unit: unit, display: display };
                }

                const roleRank = {
                    'Administrador': 1,
                    'Planner': 2,
                    'Asesor comercial': 3,
                    'Asesor de reclutamiento': 4
                };

                function getColorForRoleAndUnit(role, unit) {
                    const u = unit ? unit.toUpperCase() : 'NK';
                    if (role === 'Administrador') {
                        return (u === 'HB') ? '#c0caff' : '#7fcfda';
                    }
                    if (role === 'Planner') {
                        return '#0d4c7f';
                    }
                    if (role === 'Asesor comercial') {
                        return (u === 'HB') ? '#061bb0' : '#0d4c7f';
                    }
                    if (role === 'Asesor de reclutamiento') {
                        return (u === 'HB') ? '#061bb0' : '#0d4c7f';
                    }
                    return '#0d4c7f';
                }

                function hexToRgba(hex, alpha) {
                    const h = hex.replace('#', '');
                    const full = h.length === 3 ? h.split('').map(c => c + c).join('') : h;
                    const bigint = parseInt(full, 16);
                    const r = (bigint >> 16) & 255;
                    const g = (bigint >> 8) & 255;
                    const b = bigint & 255;
                    return `rgba(${r}, ${g}, ${b}, ${alpha})`;
                }

                function slugify(name) {
                    return name.toString().trim().toLowerCase().replace(/\s+/g, '_').replace(/[^a-z0-9_-]/g, '');
                }

                const employeesMap = {};

                fetch(queryUrl)
                    .then(r => r.text())
                    .then(text => {
                        const jsonStart = text.indexOf('{');
                        const jsonEnd = text.lastIndexOf('}');
                        if (jsonStart < 0 || jsonEnd < 0) throw new Error('Respuesta GViz inesperada');
                        const jsonString = text.substring(jsonStart, jsonEnd + 1);
                        const data = JSON.parse(jsonString);
                        const rows = (data.table && data.table.rows) || [];

                        rows.forEach(row => {
                            const name = row.c?.[0]?.v?.toString()?.trim();
                            const colC = row.c?.[1]?.v;
                            const colD = row.c?.[2]?.v;
                            const colE = row.c?.[3]?.v;
                            const colF = row.c?.[4]?.v;

                            if (!name) return;

                            const slug = slugify(name);
                            if (!employeesMap[slug]) {
                                employeesMap[slug] = { name: name, roles: [], descansoDays: [] };
                            }

                            [colC, colD, colE].forEach(raw => {
                                if (!raw) return;
                                const textRaw = raw.toString().trim();
                                if (!textRaw) return;
                                if (/^no aplica$/i.test(textRaw)) return;
                                const parts = textRaw.split(/\s*[,\/]\s*/).filter(Boolean);
                                parts.forEach(p => {
                                    const parsed = parseRoleUnit(p);
                                    if (!parsed) return;
                                    const exists = employeesMap[slug].roles.some(r => r.display?.toLowerCase() === parsed.display?.toLowerCase());
                                    if (!exists) employeesMap[slug].roles.push(parsed);
                                });
                            });

                            if (colF) {
                                const txt = colF.toString().trim();
                                if (txt) {
                                    const parts = txt.split(/\s*[,\/]\s*/).filter(Boolean);
                                    parts.forEach(p => {
                                        const dayNum = dayNameToGetDay(p);
                                        if (dayNum !== null && !employeesMap[slug].descansoDays.includes(dayNum)) {
                                            employeesMap[slug].descansoDays.push(dayNum);
                                        }
                                    });
                                }
                            }
                        });

                        const employees = Object.keys(employeesMap).map(k => employeesMap[k]);

                        employeesList.innerHTML = '';
                        employeeSelect.innerHTML = '<option value="" disabled selected>Seleccione</option>';

                        employees.forEach(emp => {
                            const card = document.createElement('div');
                            card.className = 'employee-card';

                            const nameRow = document.createElement('div');
                            nameRow.className = 'name-row';

                            const nameEl = document.createElement('div');
                            nameEl.className = 'employee-name';
                            nameEl.textContent = emp.name;

                            const roleEl = document.createElement('div');
                            roleEl.className = 'employee-role';

                            // New indicator element: simple dot with ripple effect
                            const dot = document.createElement('span');
                            dot.className = 'status-dot';
                            dot.setAttribute('aria-hidden', 'true');

                            // Determine primary role by hierarchy ranking:
                            let primary = emp.roles[0] || null;
                            emp.roles.forEach(r => {
                                const rankR = roleRank[r.role] || 99;
                                const rankP = roleRank[primary?.role] || 99;
                                if (rankR < rankP) {
                                    primary = r;
                                } else if (rankR === rankP) {
                                    if ((r.unit === 'NK') && (primary.unit !== 'NK')) {
                                        primary = r;
                                    }
                                }
                            });

                            if (!primary && emp.roles.length === 0) {
                                // fallback grey dot
                                dot.style.setProperty('--dot-color', '#cccccc');
                                dot.style.setProperty('--dot-rgba', 'rgba(0,0,0,0.08)');
                                dot.style.background = '#cccccc';
                                dot.style.boxShadow = `0 0 6px rgba(0,0,0,0.08)`;

                                nameRow.appendChild(dot);
                                nameRow.appendChild(nameEl);
                                card.appendChild(nameRow);

                                const span = document.createElement('span');
                                span.className = 'role-item';
                                span.textContent = 'No aplica';
                                span.style.opacity = '0.8';
                                roleEl.appendChild(span);
                                card.appendChild(roleEl);
                            } else {
                                const others = emp.roles.filter(r => !(r.role === primary.role && r.display.toLowerCase() === primary.display.toLowerCase()));
                                const orderedRoles = [primary, ...others];

                                const color = getColorForRoleAndUnit(primary.role, primary.unit);
                                dot.style.setProperty('--dot-color', color);
                                dot.style.setProperty('--dot-rgba', hexToRgba(color, 0.22));
                                dot.style.background = color;
                                dot.style.boxShadow = `0 0 6px ${hexToRgba(color, 0.22)}`;

                                // Build vertical role list (primary first, then secondary) centered
                                orderedRoles.forEach((r) => {
                                    const span = document.createElement('span');
                                    span.className = 'role-item';
                                    const displayLabel = r.display || (r.role + (r.unit ? ' ' + r.unit : ''));
                                    span.textContent = displayLabel;
                                    if (r.role === primary.role && ((r.unit || null) === (primary.unit || null) || r.display.toLowerCase() === primary.display.toLowerCase())) {
                                        span.classList.add('primary-role');
                                    } else {
                                        span.style.opacity = '0.95';
                                    }
                                    roleEl.appendChild(span);
                                });

                                // Compose card: nameRow (dot + name), then roleEl (stacked)
                                nameRow.appendChild(dot);
                                nameRow.appendChild(nameEl);
                                card.appendChild(nameRow);

                                card.appendChild(roleEl);
                            }

                            employeesList.appendChild(card);

                            const opt = document.createElement('option');
                            opt.value = (function(n){ return n.toString().trim().toLowerCase().replace(/\s+/g, '_').replace(/[^a-z0-9_-]/g, ''); })(emp.name);
                            opt.textContent = emp.name;
                            employeeSelect.appendChild(opt);
                        });

                        window.__novaklar_employees_map = employeesMap;

                        if (employees.length === 0) {
                            const fallback = document.createElement('div');
                            fallback.className = 'employee-card';
                            fallback.textContent = 'No se encontraron empleados.';
                            employeesList.appendChild(fallback);
                        }
                    })
                    .catch(err => {
                        console.error('Error fetching employees (GViz):', err);
                        const fallback = document.createElement('div');
                        fallback.className = 'employee-card';
                        fallback.textContent = 'No se pudieron cargar los empleados en este momento.';
                        employeesList.appendChild(fallback);
                    });
            })();

            /* -------------------------
               Calendar / Schedule logic
               ------------------------- */
            const showCalendarBtn = document.getElementById('show-calendar-btn');
            const calendarWrapper = document.getElementById('calendar-wrapper');
            const calendarEl = document.getElementById('calendar');
            const currentMonthEl = document.getElementById('current-month');
            const employeeSelect = document.getElementById('employee-select');

            function getDescansoDaysForSlug(slug) {
                const map = window.__novaklar_employees_map || {};
                return (map[slug] && map[slug].descansoDays) ? map[slug].descansoDays : [];
            }

            showCalendarBtn.addEventListener('click', function(e){
                e.stopPropagation();
                const isVisible = calendarWrapper.style.display === 'block';
                calendarWrapper.style.display = isVisible ? 'none' : 'block';
                calendarWrapper.setAttribute('aria-hidden', isVisible ? 'true' : 'false');
                if (!isVisible) generateCalendar(employeeSelect.value);
            });

            employeeSelect.addEventListener('change', function(){
                generateCalendar(employeeSelect.value);
            });

            document.addEventListener('click', function(e){
                if (calendarWrapper.style.display === 'block' && !calendarWrapper.contains(e.target) && e.target !== showCalendarBtn) {
                    calendarWrapper.style.display = 'none';
                }
            });

            function generateCalendar(selectedSlug) {
                calendarEl.innerHTML = `
                    <div class="day-name">Lun</div>
                    <div class="day-name">Mar</div>
                    <div class="day-name">Mié</div>
                    <div class="day-name">Jue</div>
                    <div class="day-name">Vie</div>
                    <div class="day-name">Sáb</div>
                    <div class="day-name">Dom</div>
                `;

                const today = new Date();
                const month = today.getMonth();
                const year = today.getFullYear();
                currentMonthEl.textContent = today.toLocaleString('es-ES', { month: 'long', year: 'numeric' });

                const firstDayOfMonth = new Date(year, month, 1).getDay();
                const daysInMonth = new Date(year, month + 1, 0).getDate();
                const startDay = firstDayOfMonth === 0 ? 6 : firstDayOfMonth - 1;

                for (let i = 0; i < startDay; i++) {
                    const emptyDay = document.createElement('div');
                    emptyDay.classList.add('day');
                    calendarEl.appendChild(emptyDay);
                }

                const descansoDays = selectedSlug ? getDescansoDaysForSlug(selectedSlug) : [];

                for (let i = 1; i <= daysInMonth; i++) {
                    const dayEl = document.createElement('div');
                    dayEl.classList.add('day');
                    dayEl.textContent = i;

                    const dayOfWeek = new Date(year, month, i).getDay();
                    if (descansoDays.includes(dayOfWeek)) {
                        dayEl.classList.add('day-off');
                        dayEl.title = 'Día de descanso';
                    }
                    calendarEl.appendChild(dayEl);
                }
            }
            generateCalendar('');

        });
    </script>
</body>
</html>
